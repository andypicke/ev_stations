---
title: "EV Charging Stations Analysis"
author: "Andy Pickering"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Libraries, echo=FALSE}

library(httr)
library(jsonlite)
library(ggplot2)
library(dplyr)
```




## Load Data For EV stations in Colorado

API documentation for the AFDC fuel-stations can be found at: https://developer.nrel.gov/docs/transportation/alt-fuel-stations-v1/all/#station-count-record-fields


```{r Load Data}
# API key is stored in my .Renviron file
api_key <- Sys.getenv("AFDC_KEY")

# base url for AFDC alternative fuel stations API
target <- "https://developer.nrel.gov/api/alt-fuel-stations/v1"

# Return data for all electric stations in Colorado
api_path <-".json?&fuel_type=ELEC&state=CO&limit=all"

complete_api_path <- paste0(target,api_path,'&api_key=',api_key)

dat <- httr::GET(url=complete_api_path)

dat2 <- jsonlite::fromJSON(httr::content(dat,"text"))

print(paste(dat2$total_results,'Stations Found'))

df <- dat2$fuel_stations

head(df)

```

### Filter out non-EV data columns

The returned data contains many non-electric fields that we don't need (they will all be NA since we requested electric fuel type only):

```{r }

colnames(df)
```

I'll remove a bunch of the non-relevant fields from the data frame to clean things up a bit.

```{r filter data}
# filter out non-EV related fields
df <- df %>% select(-starts_with("lng")) %>% 
  select(-starts_with("cng")) %>%
  select(-starts_with("lpg")) %>%
  select(-starts_with("hy")) %>% 
  select(-starts_with("ng")) %>% 
  select(-starts_with("e85")) %>% 
  select(-starts_with("bd")) %>% 
  select(-starts_with("rd"))


# change date field to date type and add a year opened variable
df$open_date <- lubridate::ymd(df$open_date)
df$open_year <- lubridate::year(df$open_date)

colnames(df)
#str(df)

```



## Station Openings Over Time



### Look at how many stations opened each year

First I'd like to look at how many EV stations opened over time, so I'll make a new data frame summarizing the number of stations opened by year.

```{r }
df_opened <- df %>% group_by(open_year) %>% summarise(nopened=n())# %>% View()
```


```{r }
df_opened %>% ggplot(aes(open_year, nopened)) + 
  geom_col()+
  xlab("Year Opened")+
  ylab("# Stations Opened")+
  ggtitle('EV Stations Opened in Colorado Each Year')

```

### Plot cumulative sum of stations opened over time

We can also look at the cumulative sum of stations opened over time

```{r}
df_opened %>% ggplot(aes(open_year,cumsum(nopened)))+
  geom_line()+
  geom_point()+
  xlab("Year")+
  ylab("# Stations")+
  ggtitle("Cumulative sum of EV stations opened in CO")
```


### Station openings by level/charger type

Next I want to dig a little deeper and break down the station openings by charger type and/or level. I'd expect to see an increase in DC fast charging stations in more recent years.

```{r}

df %>% select(id,open_date,open_year,ev_dc_fast_num,ev_level2_evse_num,ev_level1_evse_num) %>%
  group_by(open_year) %>%
  summarize(n_DC=sum(ev_dc_fast_num,na.rm = TRUE), 
            n_L2=sum(ev_level2_evse_num,na.rm = TRUE),
            n_L1=sum(ev_level1_evse_num,na.rm = TRUE) ) %>% 
  ggplot()+geom_line(aes(open_year,n_DC),col='black')+geom_line(aes(open_year,n_L2),col='red')+geom_line(aes(open_year,n_L1),col='green')
#  View()


```


##

## Count \# individual plugs by level

```{r }

n_lev1 <- sum(df$ev_level1_evse_num,na.rm=TRUE)
n_lev2 <- sum(df$ev_level2_evse_num,na.rm=TRUE)
n_dcfast <- sum(df$ev_dc_fast_num, na.rm=TRUE)

plugs <- tibble(level=c('Level1','Level2','DC Fast'), n=c(n_lev1,n_lev2,n_dcfast))

plugs %>% ggplot(aes(level,n))+
  geom_col()+
  ggtitle("Total Number of Plugs By Charging Level")

```




## Break down by connector types, ev_connector_type,ev_charging_level


```{r }

#unique(unlist(df$ev_connector_types))

df4 <- df3 %>% rowwise() %>% 
  mutate(hasJ=if_else("J1772" %in% ev_connector_types,1,0)) %>% 
  mutate(hasJcomb=if_else("J1772COMBO" %in% ev_connector_types,1,0)) %>% 
  mutate(hasChad=if_else("CHADEMO" %in% ev_connector_types,1,0)) %>% 
  mutate(hasTesla=if_else("TESLA" %in% ev_connector_types,1,0)) %>% 
  mutate(hasNema520=if_else("NEMA520" %in% ev_connector_types,1,0)) %>% 
  mutate(hasNema515=if_else("NEMA515" %in% ev_connector_types,1,0)) %>% 
  mutate(hasNema1450=if_else("NEMA1450" %in% ev_connector_types,1,0))

  View(df4)
  
df4 %>%
  select_if(is.numeric) %>%
  map_dbl(sum)  


tibble(connector_type=names(df5),n=df5) %>% View()

```


```{r }
#df %>% count(ev_network) %>% arrange(desc(n)) %>% View()

df %>%  count(ev_network) %>% 
  mutate(ev_network=as.factor(ev_network)) %>% 
  mutate(ev_network=forcats::fct_reorder(ev_network,n)) %>% 
  ggplot(aes(ev_network,n))+
  geom_col()+
  coord_flip()+
  xlab("EV Network")+
  ylab("# stations")
```
